# ============================
# ephermal notes api
# ============================

APP_NAME    ?= ephermal-notes-api
BINARY_NAME ?= $(APP_NAME)
GOBASE      := $(shell pwd)
GOBIN       := $(GOBASE)/bin

.PHONY: help build clean run lint test test-local

help:
	@echo "ğŸ§° $(APP_NAME) â€” local dev"
	@echo "  build        ğŸ”¨  Build ./bin/$(BINARY_NAME)"
	@echo "  clean        ğŸ§¹  Remove ./bin"
	@echo "  run          â–¶ï¸   Start Redis (docker-compose.dev.yaml) then go run"
	@echo "  lint         ğŸ”  golangci-lint run"
	@echo "  test         âœ…  go test -v ./..."
	@echo "  test-local   ğŸ§ª  Start Redis (test), run tests, stop Redis"

build:
	@echo "ğŸ”¨ Building Go binary â†’ $(GOBIN)/$(BINARY_NAME)"
	@mkdir -p $(GOBIN)
	@go build -o $(GOBIN)/$(BINARY_NAME) ./...

clean:
	@echo "ğŸ§¹ Cleaning build artifacts"
	@rm -rf $(GOBIN)

run:
	@echo "ğŸ˜ Starting Redis for local developmentâ€¦"
	@docker-compose -f docker-compose.dev.yaml up -d
	@sleep 3
	@echo "â–¶ï¸  Running Go applicationâ€¦"
	@go run ./...
	@echo "ğŸ›‘ Stopping Redisâ€¦"
	@docker-compose -f docker-compose.dev.yaml down

lint:
	@echo "ğŸ” Running linterâ€¦"
	@golangci-lint run

test:
	@echo "âœ… Running testsâ€¦"
	@go test -v ./...

test-local:
	@echo "ğŸ§ª Spinning up Redis for testsâ€¦"
	@docker-compose -f docker-compose.test.yaml up -d
	@sleep 3
	@echo "ğŸ§ª Running testsâ€¦"
	@go test -v ./...
	@echo "ğŸ§¹ Tearing down test Redisâ€¦"
	@docker-compose -f docker-compose.test.yaml down
