apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init-sql
data:
  10-n8n.sql: |
    DO
    $do$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'n8n_dev') THEN
        CREATE USER n8n_dev WITH ENCRYPTED PASSWORD 'n8n-dev-password';
      END IF;
    END
    $do$;

    -- Create the database if it is missing. The \gexec meta-command allows the
    -- CREATE DATABASE statement to be executed conditionally outside of a DO
    -- block (Postgres forbids CREATE DATABASE inside functions).
    SELECT 'CREATE DATABASE n8n_dev OWNER n8n_dev'
    WHERE NOT EXISTS (
      SELECT FROM pg_database WHERE datname = 'n8n_dev'
    )
    \gexec
