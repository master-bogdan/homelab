apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init-sql
data:
  $patch: replace
  10-n8n.sh: |
    #!/bin/sh
    set -eu

    if [ -z "${N8N_PASSWORD:-}" ]; then
      echo "N8N_PASSWORD is not set" >&2
      exit 1
    fi

    N8N_USER="${N8N_USER:-n8n_staging}"
    N8N_DB="${N8N_DB:-n8n_staging}"

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    DO
    $do$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${N8N_USER}') THEN
        CREATE ROLE ${N8N_USER} LOGIN ENCRYPTED PASSWORD '${N8N_PASSWORD}';
      END IF;
    END
    $do$;

    SELECT 'CREATE DATABASE ${N8N_DB} OWNER ${N8N_USER}'
    WHERE NOT EXISTS (
      SELECT FROM pg_database WHERE datname = '${N8N_DB}'
    )
    \gexec
    EOSQL
